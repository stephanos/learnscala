<!--
TODO
    - Übung
    - By-Name Parameter
-->

@defining("Currying") { implicit topic =>

    @layout.slidedeck(topic) {

        @slidehead() {
            @topic
        } {
        }

        <!-- ################################################################################## -->

        <!-- TODO: simple example - like mult(a)(b), double = mult(2) -->

        <!-- ################################################################################## -->

        @slide(title = "") {

            @sidebyside((66,33)) {
                @snippet() {
                    @sourceblock(id = "retry") {
                        |def retry[T](n: Int)(fn: => T): T = {
                        |  try {
                        |    fn
                        |  } catch {
                        |    case e if n > 1 =>
                        |      retry(n - 1)(fn)
                        |  }
                        |}
                    }
                    @outblock() {
                        |retry: [T](n: Int)(fn: => T)T
                    }
                }
            } {
                @codenote() {
                    <code>Currying</code> erlaubt es, <em>mehrere Parameterlisten</em> zu definieren
                }
            }

            @spacer()

            @sidebyside((60,40)) {
                @callcode(reference = "connect2db") {
                    |val r = retry(2) {
                    |   connectToDatabase()
                    |}
                }
            } {
                @codenote() {
                    <code>retry</code> kann wie eine Kontrollstruktur eingesetzt werden
                }
            }

            @spacer_half()

            @sidebyside((60,40)) {
                @outcode() {
                    |connecting
                    |connecting
                    |r: Boolean = true
                }
            } {
                @codenote() {
                    <em>Erfolg:</em> das Ergebnis erscheint, die erste Ausnahme wird ignoriert
                }
            }

            @spacer_half()

            @sidebyside((60,40)) {
                @outcode() {
                    |connecting
                    |connecting
                    |java.lang.AssertionError: assertion failed
                }
            } {
                @codenote() {
                    <var>Fehler:</var> nach 2 gescheiterten Versuchen wird die Ausnahme geworfen
                }
            }
        }

        <!-- ################################################################################## -->

        @defining("Beispiele") { title =>

            @*@slide(title = title, subtitle = "Thread") {

                @sidebyside((60,40)) {
                    @sourcecode(id = "ctrl-thread") {
                        |def runInThread(block: => Unit) {
                        |   new Thread {
                        |       override def run() {
                        |           block
                        |       }
                        |   }.start()
                        |}
                    }
                } {
                    @codenote() {
                        <code>runInThread</code> führt eine Funktion innerhalb eines eigenen Threads aus
                    }
                }

                @spacer()

                @sidebyside((60,40)) {
                    @snippet() {
                        @callblock(reference = "ctrl-thread") {
                            |println(Thread.currentThread.getName)
                        }
                        @outblock() {
                            |Thread-767
                        }
                        @callblock() {
                            |runInThread {
                            |   println(Thread.currentThread.getName)
                            |}
                        }
                        @outblock() {
                            |Thread-1144
                        }
                    }
                } {
                }
            }*@

            <!-- ################################################################################## -->

            @slide(title = title, subtitle = "Resource") {

                @sidebyside((75,25)) {
                    @sourcecode(id = "ctrl-resource") {
                        |import java.io._
                        |
                        |def withResource[R &lt;: Closeable](res: => R)(f: (R) => Unit) = {
                        |   val r = res
                        |   try {
                        |       f(r)
                        |   } finally {
                        |       r.close()
                        |   }
                        |}
                    }
                } {
                    @codenote() {
                        <code>withResource</code> schließt nach Ende der Funktion - oder nach einem Fehler -
                        die verwendete Resource
                    }
                }

                @spacer()

                @sidebyside((75,25)) {
                    @callcode(reference = "ctrl-resource") {
                        |withResource(new FileInputStream(new File("file.txt"))) {
                        |   stream =>
                        |       // read 'stream' ...
                        |}
                    }
                } {
                }
            }

            <!-- ################################################################################## -->

            @slide(title = title, subtitle = "Unless") {

                @sidebyside((75,25)) {
                    @sourcecode(id = "ctrl-unless") {
                        |def unless(condition: => Boolean)(body: => Unit) {
                        |   if (!condition)
                        |       body
                        |}
                    }
                } {
                    @codenote() {
                        <code>unless</code> ist das Gegenstück zu <code>if</code> - es führt eine Funktion nur aus,
                        wenn ihre Bedingung falsch ist
                    }
                }

                @spacer()

                @sidebyside((75,25)) {
                    @snippet() {
                        @callblock(reference = "ctrl-unless") {
                            |unless(1 == 42) {
                            |   print("unless!")
                            |}
                        }
                        @outblock() {
                            |unless!
                        }
                    }
                } {
                }
            }

            <!-- ################################################################################## -->

            @slide(title = title, subtitle = "Timed") {

                @sidebyside((70,30)) {
                    @sourcecode(id = "ctrl-time") {
                        |def timed[T](f: => T) = {
                        |   val start = System.nanoTime
                        |   val r = f
                        |   val t = (System.nanoTime - start) / 1e9
                        |   (r, t)
                        |}
                    }
                } {
                    @codenote() {
                        <code>timed</code> errechnet wieviel Zeit eine Funktion zur Ausführung benötigt
                    }
                }

                @spacer()

                @sidebyside((60,40)) {
                    @snippet() {
                        @callblock(reference = "factorial") {
                            |val (f, t) = timed { factorial(1000) }
                            |println(t)
                        }
                        @outblock(reference = "factorial") {
                            |0.00150658
                        }
                    }
                } {
                }
            }
        }

        <!-- ################################################################################## -->

        @uebung("S010")
    }
}

<div class="hide">
    @sourcecode(id = "factorial", reference = "ctrl-time") {
        |def factorial(n: Int): BigInt =
        |   if (n == 0) BigInt(1) else n * factorial(n - 1)
    }

    @sourcecode(id = "connect2db", reference = "retry") {
        |def connectToDatabase() = {
        |   println("connecting")
        |   assert(util.Random.nextInt(2) == 0)
        |   true
        |}
    }
</div>