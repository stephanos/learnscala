<!--
TODO
    - pattern matching
    - NodeSeq.empty
    - namespaces
    - Übung
-->

@defining("XML") { topic =>

    @layout.slidedeck(topic) {

        @slidehead() {
            @topic
        }()

        <!--################################################################################## -->

        @defining("Erstellen") { title =>

            @slide(topic = topic, title = title, subtitle = "Literale") {
                @snippet() {
                    @sourceblock() {
                        |val xml =
                        |  &lt;html&gt;
                        |    &lt;head&gt;
                        |      &lt;title&gt;Homepage&lt;/title&gt;
                        |    &lt;/head&gt;
                        |    &lt;body&gt;
                        |      Welcome!
                        |    &lt;/body&gt;
                        |  &lt;/html&gt;
                    }
                    @outblock() {
                        |xml: scala.xml.Elem =
                        |  &lt;html&gt;
                        |    &lt;head&gt;
                        |      &lt;title&gt;Homepage&lt;/title&gt;
                        |    &lt;/head&gt;
                        |    &lt;body&gt;
                        |      Welcome!
                        |    &lt;/body&gt;
                        |  &lt;/html&gt;
                    }
                }
                @codesub() {
                    <code>scala.xml.Elem</code> beschreibt ein allgemeines XML-Element
                }

                <hr/>

                @snippet() {
                    @sourceblock() {
                        |val xml = &lt;li&gt;Milk&lt;/li&gt; &lt;li&gt;Butter&lt;/li&gt; &lt;li&gt;Honey&lt;/li&gt;
                    }
                    @outblock() {
                        |xml: scala.xml.NodeSeq = &lt;li&gt;Milk&lt;/li&gt; &lt;li&gt;Butter&lt;/li&gt; &lt;li&gt;Honey&lt;/li&gt;
                    }
                }
                @codesub() {
                    Liste aus XML-Elementen ist vom Typ <code>scala.xml.NodeSeq</code>
                }
            }

            <!--################################################################################## -->

            @slide(topic = topic, title = title, subtitle = "Literale", subsubtitle = "Dynamisch") {
                @snippet() {
                    @sourceblock() {
                        |def xml(name: String) = &lt;h1&gt; Welcome {name}! &lt;/h1&gt;
                    }
                    @callblock() {
                        |xml("Paul")
                    }
                    @outblock() {
                        |res0: scala.xml.Elem = &lt;h1&gt; Welcome Paul! &lt;/h1&gt;
                    }
                }
                @codesub() {
                    dynamische Blöcke mit Scala-Code durch Umschließen von <code>@("{")</code> und <code>@("}")</code>
                }

                <hr/>

                @snippet() {
                    @callblock() {
                        |val xml = &lt;h1&gt; My favourite numbers are {{7, 42, 101}} &lt;/h1&gt;
                    }
                    @outblock() {
                        |xml: scala.xml.Elem = &lt;h1&gt; My favourite numbers are {7, 42, 101} &lt;/h1&gt;
                    }
                }
                @codesub() {
                    um eine geschweifte Klammer im Text zu verwenden, wird sie doppelt angegeben:
                    <code>@("{{")</code> bzw. <code>@("}}")</code>
                }
            }

            <!--################################################################################## -->

            @slide(topic = topic, title = title, subtitle = "Literale", subsubtitle = "Dynamisch II") {

                @snippet() {
                    @sourceblock() {
                        |&lt;h1&gt; { "Welcome & Goodbye" } &lt;/h1&gt;
                    }
                    @outblock() {
                        |res0: scala.xml.Elem = &lt;h1&gt; Welcome @("&amp;") Goodbye  &lt;/h1&gt;
                    }
                    @sourceblock() {
                        |&lt;h1&gt; { "<<< Welcome >>>" } &lt;/h1&gt;
                    }
                    @outblock() {
                        |res1: scala.xml.Elem = &lt;h1&gt; @("&lt;&lt;&lt;") Welcome @("&gt;&gt;&gt;") &lt;/h1&gt;
                    }
                }
                @codesub() {
                    XML-Zeichen wie <code>&amp;</code> sowie <code>&lt;</code> und <code>&gt;</code>
                    werden automatisch in die entsprechende Escape-Sequenz umgewandelt
                }

                <hr/>

                @snippet() {
                    @callblock() {
                        |val items = List(1, 2, 3)
                        |val xml = &lt;ul&gt; { for (i &lt;- items) yield &lt;li&gt;{i}&lt;/li&gt; } &lt;/ul &gt;
                    }
                    @outblock() {
                        |xml: scala.xml.Elem = &lt;ul&gt; &lt;li&gt;1&lt;/li&gt; &lt;li&gt;2&lt;/li&gt; &lt;li&gt;3&lt;/li&gt; &lt;/ul&gt;
                    }
                }
                @codesub() {
                    Blöcke können wiederum XML-Literale enthalten
                }

                <hr/>

                @snippet() {
                    @sourceblock() {
                        |&lt;number&gt;1&lt;/number&gt; ++ &lt;number&gt;2&lt;/number&gt;
                    }
                    @outblock() {
                        |res0: scala.xml.NodeSeq = NodeSeq(&lt;number&gt;1&lt;/number&gt;, &lt;number&gt;2&lt;/number&gt;)
                    }
                }
                @codesub() {
                    <code>++</code> verbindet zwei XML-Elemente zu einem
                }
            }

            <!--################################################################################## -->

            @slide(topic = topic, title = title, subtitle = "Literale", subsubtitle = "Attribute") {
                @snippet() {
                    @callblock() {
                        |val xml = &lt;person male="true"&gt; Paul &lt;/person&gt;
                    }
                    @outblock() {
                        |xml: scala.xml.Elem = &lt;person male="true"&gt; Paul &lt;/person&gt;
                    }
                }
                @codesub() {
                    XML-Elemente können mit Attributen versehen werden
                }

                <hr/>

                @snippet() {
                    @sourceblock() {
                        |def xml(name: String, isMale: Boolean) = &lt;person male={isMale}&gt; { name } &lt;/person&gt;
                    }
                    @callblock() {
                        |xml("Paul", true)
                    }
                    @outblock(error = true) {
                        |error: overloaded method constructor UnprefixedAttribute with alternatives: ...
                        | cannot be applied to (java.lang.String, Boolean, scala.xml.MetaData)
                    }
                }
                @codesub() {
                    Attribut-Block vom Typ <code>Boolean</code> ist <span class="underline">nicht</span> erlaubt
                }

                <hr/>

                @snippet() {
                    @sourceblock() {
                        |def xml(name: String, isMale: Boolean) = &lt;person male={isMale.toString}&gt; { name } &lt;/person&gt;
                    }
                    @callblock() {
                        |xml("Paul", true)
                    }
                    @outblock() {
                        |res0: scala.xml.Elem = &lt;person male="true"&gt; Paul &lt;/person&gt;
                    }
                }
                @codesub() {
                    Attribut-Block vom Typ <code>String</code> ist erlaubt
                }
            }

            <!--################################################################################## -->

            @*@slide(topic = topic, title = title, subtitle = "Manuell") {
                TODO
                <!--http://scalatutorial.de/topic176.html#xmlErzeugen-->
            }*@

            <!--################################################################################## -->

            @slide(topic = topic, title = title, subtitle = "Anwendungsbeispiel") {
                @snippet(id = "books_out") {
                    @sourceblock() {
                        |case class Book ( title: String, pages: Int, year: Int, available: Boolean ) {
                        |    def toXML =
                        |       &lt;book available={available toString}&gt;
                        |           &lt;title&gt; {title} &lt;/title&gt;
                        |           &lt;pages&gt; {pages} &lt;/pages&gt;
                        |           &lt;year&gt;  {year}  &lt;/year&gt;
                        |       &lt;/book&gt;
                        |}
                    }
                    @sourceblock() {
                        |val books = List( Book("Programming in Scala", 883, 2008, true),
                        |                  Book("Scala for the Impatient", 623, 2012, false) )
                    }
                }

                <hr/>

                @snippet() {
                    @callblock(reference = "books_out") {
                        |for ( book <- books )
                        |    println(book.toXML)
                    }
                    @outblock() {
                        |&lt;book available="true"&gt;
                        |   &lt;title&gt;Programming in Scala&lt;/title&gt;
                        |   &lt;pages&gt;883&lt;/pages&gt;
                        |   &lt;year&gt;2008&lt;/year&gt;
                        |&lt;/book&gt;
                        |&lt;book available="false"&gt;
                        |   &lt;title&gt;Scala for the Impatient&lt;/title&gt;
                        |   &lt;pages&gt;623&lt;/pages&gt;
                        |   &lt;year&gt;2012&lt;/year&gt;
                        |&lt;/book&gt;
                    }
                }
            }
        }

        <!--################################################################################## -->

        @slide(topic = topic, title = "Typenhierarchie") {
            <div class="sidebyside">
                @Images.xmlHierarchy()
                <div>
                    <hr/>
                    @snippet() {
                        @sourceblock() {
                            |import xml._
                            |
                            |&lt;html lang="en"&gt;             // Elem
                            |                             // + Metadata
                            |  &lt;head&gt;
                            |    &lt;title&gt;
                            |      Programming in Scala   // Text
                            |    &lt;/title&gt;
                            |  &lt;/head&gt;
                            |
                            |  &lt;body&gt;
                            |    &lt;!-- Javascript --&gt;      // Comment
                            |    &lt;script&gt; {
                            |     PCData("alert('Hello')") // PCData
                            |    } &lt;/script&gt;
                            |  &lt;/body&gt;
                            |
                            |&lt;/html&gt;
                        }
                    }
                </div>
            </div>
            <!--<hr/>
            @codenote() {
                Jedes XML-Element in Scala ist vom Typ <code>Node</code> - einem NodeSeq.
            }-->
        }

        <!--################################################################################## -->

        @defining("Auslesen") { title =>

            @slide(topic = topic, title = title, subtitle = "XPath", subsubtitle = "") {
                <div class="sidebyside p40_60">
                    @parsecode("xpath")
                    <div>
                        @snippet() {
                            @callblock(reference = "xpath") {
                                |html \ "body"
                            }
                            @outblock() {
                                |res0: scala.xml.NodeSeq = NodeSeq(&lt;body&gt; ...)
                            }
                            @callblock() {
                                |html \ "ul"
                            }
                            @outblock() {
                                |res1: scala.xml.NodeSeq = NodeSeq()
                            }
                        }
                        @codesub() {
                            Operator <code>\</code> extrahiert direkte Sub-Elemente
                        }

                        <hr class="half"/>

                        @snippet() {
                            @callblock(reference = "xpath") {
                                |(html \\ "li").length
                            }
                            @outblock() {
                                |res0: Int = 6
                            }
                        }
                        @codesub() {
                            Operator <code>\\</code> extrahiert alle Sub-Elemente
                        }

                        <hr class="half"/>

                        @snippet() {
                            @callblock(reference = "xpath") {
                                |(html \ "body" \ "_" \ "li").length
                            }
                            @outblock() {
                                |res0: Int = 6
                            }
                        }
                        @codesub() {
                             Wildcard <code>"_"</code> trifft auf alle Elemente zu
                        }

                        <hr class="half"/>

                        @snippet() {
                            @callblock(reference = "xpath") {
                                |html \ "body" \\ "@@class"
                            }
                            @outblock() {
                                |res0: scala.xml.NodeSeq = NodeSeq(clearfix, center, center)
                            }
                        }
                        @codesub() {
                            <code>@@</code> extrahiert das Attribut
                        }
                    </div>
                </div>
            }

            <!--################################################################################## -->

            @slide(topic = topic, title = title, subtitle = "XPath", subsubtitle = "") {
                <div class="sidebyside p40_60">
                    @parsecode("")
                    <div>
                        @snippet() {
                            @callblock(reference = "xpath") {
                                |(html \\ "li")(1)
                            }
                            @outblock() {
                                |res0: scala.xml.Node = <li> Scala </li>
                            }
                        }
                        @codesub() {
                            <code>Node</code> ist eine Sequenz, hat daher auch die Operationen einer Sequenz
                        }

                        <hr class="half"/>

                        @snippet() {
                            @callblock(reference = "xpath") {
                                |(html \\ "li") map { _.text.trim }
                            }
                            @outblock() {
                                |res0: Seq[String] = List("Java", "Scala", "Groovy",
                                |                         "C#", "F#", "JScript")
                            }
                        }
                        @codesub() {
                            <code>text</code> liefert Inhalt des XML-Elements
                        }

                        <hr class="half"/>

                        @snippet() {
                            @callblock(reference = "xpath") {
                                |for (e <- html \ "body" \ "_") println(e.label)
                            }
                            @outblock() {
                                |ul
                                |ol
                            }
                        }
                        @codesub() {
                            <code>label</code> liefert den Tag-Namen des XML-Elements
                        }

                        <hr class="half"/>

                        @snippet() {
                            @callblock(reference = "xpath") {
                                |(html \ "body" \ "_") map (_.attributes)
                            }
                            @outblock() {
                                |res0: Seq[MetaData] = List(class="center",
                                |                          class="center")
                            }
                        }
                        @codesub() {
                            <code>attributes</code> liefert die Meta-Daten des XML-Elements
                        }
                    </div>
                </div>
            }

            <!--################################################################################## -->

            @*@slide(topic = topic, title = title, subtitle = "Pattern Matching") {
                <div class="sidebyside p40_60">
                    @parsecode("pmatch")
                    <div>
                        @snippet() {
                            @sourceblock(reference = "pmatch") {
                                |def hasClass(n: Node, cls: String): Unit =
                                |  n match {
                                |    case n if (n.attributes("class").text == cls) =>
                                |      print(n.label)
                                |    case _ => n foreach (hasClass(_, cls))
                                |  }
                                |
                            }
                            @callblock() {
                                |hasClass(html, "center")
                            }
                            @outblock() {
                                |ul
                                |ol
                            }
                        }
                        @codesub() {

                        }

                        <hr/>

                        @snippet() {
                            @sourceblock(reference = "pmatch") {
                                |def printElem(n: Node, p: (Elem) => Boolean): Unit =
                                |  n match {
                                |    case e: Elem if(p(e)) => println(e.text.trim)
                                |    case _ => n map (printElem(_, p))
                                |  }
                            }
                            @callblock() {
                                |printElem(html, _.text contains "#")
                            }
                            @outblock() {
                                |C#
                                |F#
                            }
                        }
                        @codesub() {

                        }
                    </div>
                </div>

                <hr/>
            }

            <!--################################################################################## -->

            @slide(topic = topic, title = title, subtitle = "Pattern Matching") {
                <div class="sidebyside p40_60">
                    @parsecode("")
                    <div>
                        @snippet() {
                            @sourceblock(reference = "pmatch") {
                                |def describe(n: Node): String =
                                |  n match {
                                |    case &lt;ol&gt;{_}&lt;/ol&gt; => "ordered list with "
                                |    case &lt;ul&gt;{_}&lt;/ul&gt; => "unordered list with "
                                |    case _ => "unknown"
                                |  }
                            }
                            @callblock() {
                                |(html \ "body" \ "_") map { describe(_) } foreach println
                            }
                            @outblock() {
                                |"ordered list with "
                                |"unordered list with "
                            }
                        }
                        @codesub() {

                        }
                    </div>
                </div>

                <hr/>
            }*@

            <!--################################################################################## -->

            @slide(topic = topic, title = title, subtitle = "Anwendungsbeispiel") {
                @snippet(id = "books_in") {
                    @sourceblock() {
                        |case class Book ( title: String, pages: Int, year: Int, available: Boolean )
                        |
                        |object Book {
                        |
                        |  def apply ( xml: scala.xml.NodeSeq ): Book = {
                        |    val avble = (xml \\ "@@available").text == "true"
                        |    val title = (xml \\ "title").text
                        |    val pages = (xml \\ "pages").text.toInt
                        |    val year  = (xml \\ "year" ).text.toInt
                        |
                        |    new Book (title, pages, year, avble)
                        |  }
                        |}
                    }
                }
                <hr/>
                @snippet() {
                    @callblock(reference = "books_in") {
                        |Book(&lt;book available="true"&gt;
                        |       &lt;title&gt;Programming in Scala&lt;/title&gt;
                        |       &lt;pages&gt;883&lt;/pages&gt;
                        |       &lt;year&gt;2008&lt;/year&gt;
                        |     &lt;/book&gt;)
                    }
                    @outblock() {
                        |res0: Book = Book(Programming in Scala,883,2008,true)
                    }
                }
            }
        }

        <!--################################################################################## -->

        @defining("Transformieren") { title =>
            @slide(topic = topic, title = title) {
                <div class="sidebyside p40_60">
                    @snippet() {
                        @sourcecode(id = "transform") {
                            |val html =
                            |  &lt;html&gt;
                            |    &lt;body&gt;
                            |      &lt;ul&gt; // unordered
                            |        &lt;li&gt; Java &lt;/li&gt;
                            |        &lt;li&gt; Scala &lt;/li&gt;
                            |        &lt;li&gt; Groovy &lt;/li&gt;
                            |      &lt;/ul&gt;
                            |      &lt;ol&gt; // ordered
                            |        &lt;li&gt; C# &lt;/li&gt;
                            |        &lt;li&gt; F# &lt;/li&gt;
                            |        &lt;li&gt; JScript &lt;/li&gt;
                            |      &lt;/ol&gt;
                            |    &lt;/body&gt;
                            |  &lt;/html&gt;
                        }
                        @outblock() {
                            |  &lt;html&gt;
                            |    &lt;body&gt;
                            |      &lt;ol&gt; // ordered
                            |        &lt;li&gt; Java &lt;/li&gt;
                            |        &lt;li&gt; Scala &lt;/li&gt;
                            |        &lt;li&gt; Groovy &lt;/li&gt;
                            |      &lt;/ol&gt;
                            |      &lt;ul&gt; // unordered
                            |        &lt;li&gt; C# &lt;/li&gt;
                            |        &lt;li&gt; F# &lt;/li&gt;
                            |        &lt;li&gt; JScript &lt;/li&gt;
                            |      &lt;/ul&gt;
                            |    &lt;/body&gt;
                            |  &lt;/html&gt;
                        }
                    }
                    <div>
                        @callcode(reference = "transform") {
                            |import scala.xml._
                            |import scala.xml.transform._
                            |
                            |val trfrm = new RewriteRule {
                            |  override def transform(n: Node) =
                            |    n match {
                            |      case e: Elem if(e.label == "ul") =>
                            |        e.copy(label = "ol")
                            |      case e: Elem if(e.label == "ol") =>
                            |        e.copy(label = "ul")
                            |      case _ => n
                            |    }
                            |}
                            |
                            |new RuleTransformer(trfrm).transform(html)
                        }
                        @codesub() {
                            <code>RuleTransformer</code> kann eine oder mehrere <code>RewriteRule</code>
                            auf einen <code>Node</code> und dessen Sub-Elemente anwenden
                        }
                    </div>
                </div>

                <hr/>
            }
        }

        <!--################################################################################## -->

        @defining("Speichern und Laden") { title =>
            @slide(topic = topic, title = title) {
                @snippet() {
                    @sourceblock() {
                        |val xml = &lt;ul&gt; &lt;li&gt;Milk&lt;/li&gt; &lt;li&gt;Butter&lt;/li&gt; &lt;li&gt;Honey&lt;/li&gt; &lt;/ul&gt;
                    }
                    @outblock() {
                        |xml: scala.xml.Elem = &lt;ul&gt; &lt;li&gt;Milk&lt;/li&gt; &lt;li&gt;Butter&lt;/li&gt; &lt;li&gt;Honey&lt;/li&gt; &lt;/ul&gt;
                    }
                    @callblock(id = "save") {
                        |scala.xml.XML.save("shoppinglist.xml", xml)
                    }
                }
                @codesub() {
                    Objekt <code>XML</code> bietet eine <code>save</code>-Methode zum serialisieren einer <code>Node</code>-Instanz
                }

                <hr/>

                @snippet() {
                    @callblock(reference = "save") {
                        |scala.xml.XML.loadFile("shoppinglist.xml")
                    }
                    @outblock() {
                        |res0: scala.xml.Elem = &lt;ul&gt; &lt;li&gt;Milk&lt;/li&gt; &lt;li&gt;Butter&lt;/li&gt; &lt;li&gt;Honey&lt;/li&gt; &lt;/ul&gt;
                    }
                }
                @codesub() {
                    <code>loadFile</code> kann eine Datei laden und parst den Inhalt mit Hilfe von Javas SAX Parser
                }
            }
        }

        <!--################################################################################## -->

        @uebung() {
            TODO
        }
    }
}

@parsecode(id: String) = {
    @sourcecode(id = id) {
        |import xml._
        |
        |val html =
        |  &lt;html&gt;
        |
        |    &lt;body class="clearfix"&gt;
        |
        |      &lt;ul class="center"&gt;
        |        &lt;li&gt; Java &lt;/li&gt;
        |        &lt;li&gt; Scala &lt;/li&gt;
        |        &lt;li&gt; Groovy &lt;/li&gt;
        |      &lt;/ul&gt;
        |
        |      &lt;ol class="center"&gt;
        |        &lt;li&gt; C# &lt;/li&gt;
        |        &lt;li&gt; F# &lt;/li&gt;
        |        &lt;li&gt; JScript &lt;/li&gt;
        |      &lt;/ol&gt;
        |
        |    &lt;/body&gt;
        |
        |  &lt;/html&gt;
    }
}