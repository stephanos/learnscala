<!--
    - Trampolines
-->
@defining("Rekursion") { implicit topic =>

    @layout.slidedeck(topic) {

        @slidehead() {
            @topic
        } {

        }

        <!-- ################################################################################## -->

        @slide(title = "imperativ") {

            @snippet() {
                @sourceblock(fragment = false) {
                    |def factorial(n: Int): BigInt = {
                    |   var acc = BigInt(1)
                    |   for (i <- 2 to n) {
                    |     acc *= i
                    |   }
                    |   acc
                    |}
                }
                @outblock() {
                    |factorial: (n: Int)Int
                }
            }
            @codesub2() {
                imperativer Algorithmus zur Berechnung der Fakultät
            }

            @spacer()

            @snippet() {
                @callblock() {
                    |factorial(4)
                }
                @outblock() {
                    |res0: BitInt = 24
                }
                @callblock() {
                    |factorial(10000)
                }
                @outblock() {
                    |res1: BigInt = 2846259680917054518906..
                }
            }
        }

        <!-- ################################################################################## -->

        @slide(title = "Overflow") {

            @snippet() {
                @sourceblock(fragment = false) {
                    |def factorial(n: Int) =
                    |   if (n == 0) BigInt(1) else n * factorial(n - 1)
                }
                @outblock(error = true) {
                    |error: recursive method factorial needs result type
                }
            }

            @codesub2() {
                rekursive Methoden brauchen einen Rückgabetyp
            }

            @spacer()

            @snippet() {
                @sourceblock(id = "factorial1") {
                    |def factorial(n: Int): BigInt =
                    |   if (n == 0) BigInt(1) else n * factorial(n - 1)
                }
            }

            @spacer()

            @snippet() {
                @outblock(reference = "factorial1") {
                    |factorial: (n: Int)BigInt
                }
                @callblock() {
                    |factorial(4)
                }
                @outblock() {
                    |res0: BitInt = 24
                }
                @callblock() {
                    |factorial(10000)
                }
                @outblock(error = true) {
                    |java.lang.StackOverflowError
                }
            }

            @codesub2() {
                <var>Problem:</var> jeder rekursive Aufruf öffnet einen neuen Stack
            }
        }

        <!-- ################################################################################## -->

        @defining("tailrec") { title =>

            @slide(title = title, subtitle = "A") {

                @snippet() {
                    @sourceblock(fragment = false) {
                        |import scala.annotation.tailrec
                        |
                        |@@tailrec
                        |def factorial(n: Int): BigInt =
                        |   if (n == 0) BigInt(1) else n * factorial(n - 1)
                    }
                    @outblock(error = true) {
                        |error: could not optimize @@tailrec annotated method:
                        |       contains recursive call not in tail position
                    }
                }

                    @codesub2() {
                        Annotation <code>@@tailrec</code> wandelt
                        rekursive Funktion in eine Schleife um
                        <br/>
                        <var>Bedingung:</var> letzte Anweisung ist Rekursionsaufruf
                    }

                @spacer()

                @snippet() {
                    @sourceblock() {
                        |import scala.annotation.tailrec
                        |
                        |@@tailrec
                        |def factorial(n: Int, acc: BigInt): BigInt =
                        |   if (n == 0) acc else factorial(n - 1, acc * n)
                    }
                    @outblock() {
                        |factorial: (n: Int, acc: BigInt)BigInt
                    }
                }

                    @codesub2() {
                        Zwischenergebnis der Multiplikation wird zu Parameter
                        <br/>
                        <var>Nachteil:</var> Hilfsparameter ist Teil der Signatur
                    }
            }

            <!-- ################################################################################## -->

            @slide(title = title, subtitle = "B") {

                @snippet() {
                    @sourceblock(id = "tailrec", fragment = false) {
                        |import scala.annotation.tailrec
                        |
                        |def factorial(n: BigInt): Int = {
                        |
                        |  @@tailrec
                        |  def factorial(n: Int, acc: BigInt): Int =
                        |    if (n == 0) acc else factorial(n - 1, acc * n)
                        |
                        |  factorial(n, 1)
                        |}
                    }
                    @outblock() {
                        |factorial: (n: Int)BigInt
                    }
                }

                    @codesub2() {
                        <em>Lösung:</em>
                        Definition einer internen Methode
                    }

                @spacer()

                @snippet() {
                    @callblock(reference = "tailrec") {
                        |factorial(4)
                    }
                    @outblock() {
                        |res0: BitInt = 24
                    }
                    @callblock() {
                        |factorial(10000)
                    }
                    @outblock() {
                        |res1: BigInt = 2846259680917054518906..
                    }
                }
                    @codesub2() {
                        <em>Ergebnis:</em> Kein <code>StackOverflow</code> mehr
                    }
            }
        }

        <!-- ################################################################################## -->

        @uebung("030") {

            Die Übung ist unter
                <code>/src/main/scala/de/learnscala/uebungen/<em>U430.scala</em></code>
            zu finden.

            @spacer()

            Die dazugehörige Testspezifikation unter
                <code>/src/test/scala/de/learnscala/specs/<var>U430.scala</var></code>.
        }
    }
}