<!--
    - Trampolines
-->
@defining("Rekursion") { implicit topic =>

    @layout.slidedeck(topic) {

        @slidehead() {
            @topic
        } {

        }

        <!--################################################################################## -->

        @slide() {

            @sidebyside((60,40)) {
                @snippet() {
                    @sourceblock(fragment = false) {
                        |def factorial(n: Int): BigInt = {
                        |   var acc = BigInt(1)
                        |   for (i <- 2 to n) {
                        |     acc *= i
                        |   }
                        |   acc
                        |}
                    }
                    @outblock() {
                        |factorial: (n: Int)Int
                    }
                }

                @spacer()

                @snippet() {
                    @callblock() {
                        |factorial(4)
                    }
                    @outblock() {
                        |res0: BitInt = 24
                    }
                    @callblock() {
                        |factorial(10000)
                    }
                    @outblock() {
                        |res1: BigInt = 2846259680917054518906..
                    }
                }
            } {
            }
        }

        <!--################################################################################## -->

        @slide() {

            @sidebyside((60,40)) {
                @snippet() {
                    @sourceblock(fragment = false) {
                        |def factorial(n: Int) =
                        |   if (n == 0) BigInt(1) else n * factorial(n - 1)
                    }
                    @outblock(error = true) {
                        |error: recursive method factorial needs result type
                    }
                }
            } {
            }

            @spacer()

            @sidebyside((60,40)) {
                @snippet() {
                    @sourceblock() {
                        |def factorial(n: Int): BigInt =
                        |   if (n == 0) BigInt(1) else n * factorial(n - 1)
                    }
                    @outblock() {
                        |factorial: (n: Int)BigInt
                    }
                    @callblock() {
                        |factorial(4)
                    }
                    @outblock() {
                        |res0: BitInt = 24
                    }
                    @callblock() {
                        |factorial(10000)
                    }
                    @outblock(error = true) {
                        |java.lang.StackOverflowError
                    }
                }
            } {
                @codenote() {

                }
            }
        }

        <!--################################################################################## -->

        @slide() {
            <!-- @@tailrec I -->

            @sidebyside((60,40)) {
                @snippet() {
                    @sourceblock(fragment = false) {
                        |import scala.annotation.tailrec
                        |
                        |@@tailrec
                        |def factorial(n: Int): BigInt =
                        |   if (n == 0) BigInt(1) else n * factorial(n - 1)
                    }
                }
            } {
                @codenote() {
                    Annotation <code>@@tailrec</code> stellt sicher,
                    dass der Compiler die rekursive Funktion intern in eine Schleife umwandelt
                }
            }
            @sidebyside((60,40)) {
                @snippet() {
                    @outblock(error = true) {
                        |error: could not optimize @@tailrec annotated method:
                        |       contains recursive call not in tail position
                    }
                }
            } {
                @codenote() {
                    <var>Bedingung:</var> letzte Anweisung ist Rekursionsaufruf
                }
            }

            @spacer2()

            @sidebyside((60,40)) {
                @snippet() {
                    @sourceblock() {
                        |import scala.annotation.tailrec
                        |
                        |@@tailrec
                        |def factorial(n: Int, acc: BigInt): BigInt =
                        |   if (n == 0) acc else factorial(n - 1, acc * n)
                    }
                }
            } {
                @codenote() {
                    Zwischenergebnis der Multiplikation wird zu Parameter
                }
            }

            @sidebyside((60,40)) {
                @snippet() {
                    @outblock() {
                        |factorial: (n: Int, acc: BigInt)BigInt
                    }
                }
            } {
                @codenote() {
                    <var>Nachteil:</var> Hilfsparameter ist Teil der Signatur
                }
            }
        }

        <!--################################################################################## -->

        @slide() {
            <!-- @@tailrec II -->

            @sidebyside((60,40)) {
                @snippet() {
                    @sourceblock(id = "tailrec", fragment = false) {
                        |import scala.annotation.tailrec
                        |
                        |def factorial(n: BigInt): Int = {
                        |  @@tailrec
                        |  def factorial(n: Int, acc: BigInt): Int =
                        |    if (n == 0) acc else factorial(n - 1, acc * n)
                        |
                        |  factorial(n, 1)
                        |}
                    }
                    @outblock() {
                        |factorial: (n: Int)BigInt
                    }
                }
            } {
                @codenote() {
                    <em>Lösung:</em>
                    Definition einer internen Methode
                }
            }

            @spacer2()

            @sidebyside((60,40)) {
                @snippet() {
                    @callblock(reference = "tailrec") {
                        |factorial(4)
                    }
                    @outblock() {
                        |res0: BitInt = 24
                    }
                    @callblock() {
                        |factorial(10000)
                    }
                    @outblock() {
                        |res1: BigInt = 2846259680917054518906..
                    }
                }
            } {
                @codenote() {
                    Kein <code>StackOverflow</code> mehr
                }
            }
        }

        <!--################################################################################## -->

        @uebung("030") {

            Die Übung ist unter
                <code>/src/main/scala/de/learnscala/uebungen/<em>U430.scala</em></code>
            zu finden.

            @spacer()

            Die dazugehörige Testspezifikation unter
                <code>/src/test/scala/de/learnscala/specs/<var>U430.scala</var></code>.
        }
    }
}